# AIPerf 特性梳理（按版本划分）

本文档基于发布历史，梳理了 AIPerf 各个版本的主要特性。

---

## v0.1.1 - 初始版本

### 核心功能

#### 1. 综合性能基准测试
- **详细性能指标**：测量吞吐量、延迟和全面的 token 级别指标
- **灵活数据源**：支持合成和数据集驱动的输入模式
- **多进程支持**：本地扩展的并行处理能力

#### 2. 可扩展负载生成
- **并行处理**：多进程支持，实现本地扩展
- **可配置负载模式**：
  - 高并发模式
  - 请求速率模式
  - 可配置的负载模式

#### 3. 追踪回放
- **生产工作负载模拟**：重现真实世界或合成工作负载追踪
- **行业标准格式**：支持 Mooncake 追踪格式和自定义 JSONL 数据集（使用 `--fixed-schedule` 选项时）

#### 4. 灵活的模型和端点支持
- **通用兼容性**：支持 OpenAI 兼容 API，包括 vLLM、Dynamo 等
- **OpenAI API 支持**：
  - Chat completions
  - Completions
  - Embeddings

#### 5. 高级输入输出配置
- **细粒度 Token 控制**：对输入/输出 token 数量和流式传输的精细控制
- **扩展请求支持**：向端点传递额外输入和自定义负载

#### 6. 丰富的报告和导出
- **多种导出选项**：控制台、CSV 和 JSON 输出格式
- **工件管理**：支持工件目录，用于保存日志和指标

#### 7. 自动化和集成
- **CLI 优先设计**：面向脚本和自动化的 CLI 优先工作流
- **部署灵活性**：兼容容器化和云环境

#### 8. 安全性和自定义
- **安全和认证**：支持自定义标头、认证和高级 API 选项
- **确定性测试**：随机种子和可重现性控制

#### 9. 控制台 UI 选项
- **实时监控**：实时指标仪表板，包含实时进度跟踪和工作器状态监控
- **多种 UI 模式**：
  - 简单 UI 模式：用于流式监控
  - 无头模式：用于自动化环境

### 关键改进（相比 GenAI-Perf）

#### 性能和扩展性
- **分布式架构**：为水平扩展构建的可扩展服务导向设计
- **Python 多进程**：原生多进程实现，自动工作器配置和生命周期管理
- **请求速率与最大并发**：结合请求速率控制和并发限制

#### 用户体验
- **实时仪表板**：基于终端的交互式 UI，实时指标可视化
- **多种 UI 模式**：仪表板模式、简单模式、无头模式

#### 可观测性和控制
- **API 错误分析**：全面的请求失败跟踪和分类
- **早期终止支持**：在运行中取消基准测试，同时保留所有已完成的结果

#### 可扩展性和集成
- **纯 Python 架构**：消除复杂的混合语言依赖
- **ShareGPT 集成**：自动下载、缓存和处理公共数据集

---

## v0.2.0

### 新功能

#### 1. 基于时间的基准测试
- **基于时间的基准测试支持**：在指定持续时间内运行基准测试
- **基准测试宽限期**：配置宽限期功能，允许适当的预热和冷却阶段
- **可配置宽限期**：更真实的测试场景

#### 2. 请求管理和控制
- **请求取消**：在基准测试期间取消请求的能力，用于测试超时行为和服务弹性
- **Mooncake 追踪的固定调度**：增强的追踪回放，支持固定调度检测和非固定调度追踪格式
- **带并发限制的请求速率**：限制 HTTP 连接和控制请求并发的能力，用于更真实的负载测试

#### 3. 高级指标和监控
- **Goodput 指标**：测量满足用户定义 SLO 的请求吞吐量，包含全面的教程支持
- **GPU 遥测**：集成 GPU 监控和遥测收集，用于全面的性能分析
- **分块间延迟指标**：使用原始值列表进行详细流式性能分析的分块间延迟跟踪
- **总 ISL/OSL 指标**：总输入/输出序列长度指标，改进的 CSV/JSON 导出支持
- **每记录指标导出**：在 `profile_export.jsonl` 中增强配置文件导出，包含每记录指标
- **混合 ISL/OSL 分布**：在基准测试中支持混合输入/输出序列长度分布

#### 4. 视频和多媒体支持
- **合成视频支持**：添加视频基准测试和合成视频生成支持

#### 5. 增强的数据管理
- **inputs.json 文件用于数据集可追溯性**：通过生成 inputs.json 文件实现数据集可追溯性
- **请求可追溯性标头**：添加 X-Request-Id 和 X-Correlation-Id 标头，改进请求跟踪

### 错误修复

#### 核心功能
- **ZMQ 优雅终止**：修复 ZMQ 上下文的优雅终止，防止进程挂起
- **工作器数量限制**：将默认最大工作器数限制为 32，防止资源耗尽
- **信用发放中的竞争条件**：修复信用发放策略中的竞争条件，提高性能稳定性
- **启动错误处理**：改进启动期间的错误处理，提供清晰的错误消息和正确的进程退出

#### 请求处理
- **空选择数组处理**：修复 OpenAI 选择数组为空时的 IndexError
- **请求元数据验证**：修复失败请求的请求元数据验证错误

#### 导出和数据处理
- **CSV 导出逻辑**：修复 CSV 导出解析，确保正确的数据格式
- **JSONL 文件写入**：解决写入 JSONL 文件的问题
- **GenAI-Perf JSON 格式兼容性**：修复 JSON 摘要导出以匹配 GenAI-Perf 格式

#### 平台特定修复
- **macOS Textual UI 仪表板**：修复 macOS 系统上 Textual UI 仪表板的兼容性问题
- **图像测试随机种子**：为图像测试设置适当的随机种子，修复偶发测试失败

#### 遥测和性能
- **遥测管理器关闭时序**：修复遥测管理器在配置文件配置完成之前关闭的问题
- **Goodput 发布问题**：修复 goodput 相关发布问题的补丁
- **CPU 使用警告**：添加工作器 CPU 使用超过 85% 时的警告，帮助识别性能瓶颈

### 文档和教程

#### 新文档
- **Goodput 教程**：关于使用 goodput 指标进行 SLO 验证的完整教程
- **高级功能教程**：涵盖高级基准测试功能的教程
- **使用真实数据的追踪回放教程**：使用真实 Mooncake 数据示例更新追踪回放教程
- **与 GenAI-Perf 的功能比较**：添加 AIPerf 和 GenAI-Perf 之间的详细功能比较矩阵

### 基础设施和开发

#### 构建和依赖
- **灵活依赖**：使包依赖更加灵活，提高兼容性
- **PyProject.toml 清理**：清理和组织 pyproject.toml 配置
- **许可证字段合规性**：更新 pyproject.toml 许可证字段以符合 wheeltamer
- **依赖更新**：移除 pandas 依赖（现在仅使用 numpy），更新 numpy 到 1.26.4

#### 重构和性能
- **核心组件**：信用处理器重构，提高性能和可维护性
- **控制台输出增强**：在控制台输出中添加中位数值，提供更好的统计洞察
- **性能测试标记**：正确标记 SSE 测试为性能测试，改进测试组织

---

## v0.3.0

### 高级指标和分析

#### 1. 时间切片指标
- **时间切片持续时间选项**：添加 `--slice-duration` 选项用于时间切片指标分析（#300）
- **时间切片导出格式**：实现 JSON 和 CSV 输出格式用于时间切片指标（#411）
- **时间切片计算管道**：添加时间切片指标结果计算并移交给 ExportManager（#378）
- **时间切片文档**：时间切片指标功能的全面教程文档（#420）

#### 2. 多轮对话
- **多轮支持**：完整实现多轮对话基准测试（#360）
- **轮次间延迟**：可配置的对话轮次间延迟（#452, #455）

#### 3. 指标和准确性
- **首次输出时间（非推理）**：排除推理 token 的新指标（#359），提供准确的用户感知延迟测量
- **服务器 Token 计数**：解析和报告服务器提供的使用数据（#405）
- **错误记录转换**：将无效解析响应转换为错误记录（#416）
- **SSE 错误解析**：增强 SSE 解析以检测和处理来自 Dynamo 和其他服务器的错误事件（#385）
- **嵌套输入解析**：修复嵌套列表/元组的解析（#318）

### 端点生态系统扩展

#### 1. 自定义端点集成
- **Jinja 模板负载**：完全自定义的 Jinja 模板支持用于端点负载（#406），带自动转义安全（#461）
- **端点/传输解耦**：重构架构以解耦端点和传输（#389）
- **URL 灵活性**：支持 URL 中的 /v1 后缀（#349）

#### 2. 端点集成
- **Hugging Face TEI**：添加对 Hugging Face Text Embeddings Inference 端点的支持，包含排名 API（#398, #419）
- **Hugging Face TGI**：原生支持 Hugging Face Text Generation Inference 生成端点（#412, #419）
- **Cohere Rankings API**：与 Cohere Rankings API 集成（#398, #419）
- **Solido RAG 端点**：支持 Solido RAG 端点（#396）

### GPU 遥测和可观测性

- **实时仪表板**：GPU 遥测实时仪表板显示（#370）
- **DCGM 模拟器**：真实的 DCGM 指标模拟器（#361）
- **端点可达性**：改进 GPU 遥测端点可达性日志记录（#397）
- **默认端点**：添加 `http://localhost:9400/metrics` 到默认遥测端点（#369）

### 视频生成

- **WebM/VP9 支持**：添加 WebM 容器和 VP9 编解码器支持到视频生成器（#460）
- **视频教程**：全面的视频生成教程文档（#409）

### 可重现性

- **顺序无关 RNG**：使用顺序无关的 RandomGenerator 系统强化可重现性（#415）

### 数据集和配置

- **数据集采样器**：新的数据集采样器实现（#395）
- **数据集条目选项**：将 `--dataset-entries` CLI 选项与 `--num-conversations` 分离（#421）
- **环境设置**：将常量移动到 Pydantic 环境设置（#390）

### 开发者体验

#### 1. 项目结构
- **项目结构**：将 aiperf 移动到 src/ 目录（#387）
- **Mock 服务器自动安装**：make install 自动安装 mock 服务器（#382）
- **E2E 集成测试**：全面的 e2e 集成测试，包含 mock 服务器，覆盖所有端点（#377）

#### 2. 跨平台支持
- **Windows 支持**：自动检测并在 Windows 上禁用 uvloop（#413）
- **macOS 信号量清理修复**：修复 macOS 信号量清理（#379）
- **macOS 测试错误**：修复由于不正确补丁导致的 macOS 虚假测试错误（#422）
- **Python 版本支持**：在 Ubuntu 和 macOS 上对 Python 3.10、3.11、3.12 进行单元测试（#356）
- **Docker 合规性**：Dockerfile OSRB 合规性（#337）和 Python 3.13 支持（#454, #478）

#### 3. 用户体验
- **详细日志**：-v 和 -vv 标志自动启用简单 UI 模式（#401）
- **全屏日志**：显示全屏日志直到第一条进度消息（#402）
- **仪表板截图**：在 README 中添加仪表板截图（#371）
- **请求速率文档**：关于请求速率与最大并发的全面文档（#380）

### 性能和稳定性

- **Goodput 计算**：修复 goodput 发布计算问题（#373）
- **SSE 分块解析**：修复当多个消息在单个缓冲分块中到达时的 SSE 解析（#368）
- **任务取消**：在取消之前等待刷新任务完成（#404）
- **日志队列清理**：为日志队列清理添加超时（#393）
- **ZMQ 上下文终止**：修复 ZMQ 上下文终止和 TimeoutError 问题（#474）
- **GPU 遥测时序**：修复遥测管理器关闭竞争条件（#367）

### 文档

- **时间切片教程**：时间切片指标的教程文档（#420）
- **视频生成教程**：全面的视频生成教程（#409）
- **API 文档**：HF TEI、HF TGI、Cohere API 支持的文档（#419）
- **迁移指南**：迁移指南中关于推理 token 的注释（#365）
- **GAP 比较**：更新 AIPerf vs GenAI-Perf 比较文档（#408）
- **数据集条目**：更新文档以使用数据集条目而不是 num conversations（#430）

### 错误修复

- **ZMQ 上下文终止**：修复 ZMQ 上下文终止和 TimeoutError 问题（#474）
- **Jinja 自动转义**：修复 Jinja 模板中的自动转义（#461）
- **SSE 多条消息**：修复当多个消息在单个缓冲分块中到达时的 SSE 解析（#368）
- **任务取消**：在取消之前等待刷新任务完成（#404）
- **日志队列超时**：为日志队列清理添加超时（#393）
- **GPU 遥测关闭**：修复遥测管理器关闭时序问题（#367）
- **GPU 遥测已弃用字段**：修复系统控制器使用已弃用的 endpoints_tested 字段（#376）
- **嵌套输入解析**：修复嵌套列表/元组的解析（#318）
- **macOS 测试错误**：修复由于不正确补丁导致的 macOS 虚假测试错误（#422）
- **时间切片教程拼写错误**：修复时间切片教程文档中的拼写错误（#436）

### 已知问题

#### 破坏性变更：排名端点类型
- 通用的 `--endpoint-type rankings` 已在 v0.3.0 中移除
- **迁移要求**：使用特定于提供商的类型：
  - `--endpoint-type nim_rankings` (NVIDIA NIM)
  - `--endpoint-type hf_tei_rankings` (Hugging Face TEI)
  - `--endpoint-type cohere_rankings` (Cohere)

---

## 版本特性总结

### 核心能力演进

| 版本 | 主要焦点 | 关键特性 |
|------|---------|---------|
| **v0.1.1** | 基础功能 | 多进程支持、追踪回放、实时仪表板、ShareGPT 集成 |
| **v0.2.0** | 高级指标 | 基于时间的基准测试、Goodput 指标、GPU 遥测、视频支持 |
| **v0.3.0** | 生态系统扩展 | 时间切片指标、多轮对话、端点生态系统扩展、可重现性增强 |

### 功能分类

#### 基准测试模式
- **v0.1.1**: 并发模式、请求速率模式、追踪回放
- **v0.2.0**: 基于时间的基准测试、固定调度
- **v0.3.0**: 多轮对话、时间切片分析

#### 端点支持
- **v0.1.1**: OpenAI 兼容 API（chat、completions、embeddings）
- **v0.2.0**: 无新增
- **v0.3.0**: Hugging Face TEI/TGI、Cohere Rankings、Solido RAG、自定义 Jinja 模板

#### 指标和分析
- **v0.1.1**: 基础吞吐量、延迟、token 级别指标
- **v0.2.0**: Goodput、GPU 遥测、分块间延迟、ISL/OSL 指标
- **v0.3.0**: 时间切片指标、首次输出时间（非推理）、服务器 token 计数

#### 可观测性
- **v0.1.1**: 实时仪表板、简单 UI 模式
- **v0.2.0**: GPU 遥测集成
- **v0.3.0**: GPU 遥测实时仪表板、DCGM 模拟器

#### 可重现性
- **v0.1.1**: 随机种子支持
- **v0.2.0**: 无新增
- **v0.3.0**: 顺序无关 RNG 系统

#### 开发者体验
- **v0.1.1**: 纯 Python 架构、CLI 优先设计
- **v0.2.0**: 依赖优化、重构
- **v0.3.0**: src/ 目录布局、E2E 测试、跨平台支持、Mock 服务器

#### 多媒体支持
- **v0.1.1**: 无
- **v0.2.0**: 合成视频支持
- **v0.3.0**: WebM/VP9 视频支持

---

## 版本间迁移注意事项

### v0.2.0 → v0.3.0
- **破坏性变更**：`--endpoint-type rankings` 已移除，需要使用特定提供商的类型
- **新功能**：时间切片指标、多轮对话、扩展端点支持
- **改进**：可重现性增强、跨平台支持改进

### v0.1.1 → v0.2.0
- **新功能**：基于时间的基准测试、Goodput 指标、GPU 遥测
- **改进**：错误处理、性能优化、文档增强

---

*最后更新：基于 v0.3.0 发布说明*

